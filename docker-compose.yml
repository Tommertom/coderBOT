version: "3.8"

services:
  coderbot:
    image: node:20-bookworm
    container_name: coderbot
    restart: unless-stopped

    # Use the Dockerfile for full setup, or comment this out and use the command below for quick start
    # build:
    #   context: .
    #   dockerfile: Dockerfile

    # Quick start command using npx (no build required)
    command: >
      bash -c "
      apt-get update && apt-get install -y curl git bash &&
      apt-get install -y ca-certificates fonts-liberation libasound2 libatk-bridge2.0-0 libatk1.0-0 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libglib2.0-0 libgtk-3-0 libnspr4 libnss3 libpango-1.0-0 libpangocairo-1.0-0 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 xdg-utils &&
      rm -rf /var/lib/apt/lists/* &&
      if [ ! -f /app/.env ]; then
        echo '⚠️  No .env file found. Please create /app/.env with your configuration.';
        exit 1;
      fi &&
      npm install -g @github/copilot &&
      npm install -g @anthropic-ai/claude-code &&
      cd /app &&
      npx -y @tommertom/coderbot
      "

    working_dir: /app

    # Environment variables - you can either:
    # 1. Mount .env file as shown in volumes below, OR
    # 2. Set variables here directly, OR
    # 3. Use env_file directive
    # env_file:
    #   - .env

    environment:
      - NODE_ENV=production
      - XTERM_SHELL_PATH=/bin/bash

    # Volume mounts
    volumes:
      # REQUIRED: Mount your .env file
      - ./.env:/app/.env:ro

      # Persist logs
      - ./logs:/app/logs

      # Media folders for each bot worker
      - ./media:/tmp/coderBOT_media

      # Optional: Persist terminal history
      - terminal_history:/home/node

      # Optional: Mount a working directory for file operations
      - bot_workspace:/workspace

      # Optional: Persist GitHub CLI authentication (for Copilot CLI)
      - gh_config:/home/node/.config/gh

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Security options
    security_opt:
      - no-new-privileges:true

    # Network configuration
    network_mode: "bridge"

    # Health check (optional)
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  terminal_history:
    driver: local
  bot_workspace:
    driver: local
  gh_config:
    driver: local
